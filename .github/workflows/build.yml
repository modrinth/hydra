# DO NOT EDIT THIS FILE! Edit /workflows/<name>.ncl and run cargo make build-ci intead.
---
env:
  CARGO_TERM_COLOR: always
jobs:
  build:
    permissions:
      contents: read
      packages: write
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: cachix/install-nix-action@v17
        with:
          extra_nix_config: "access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}\ntrusted-public-keys = cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY=\nsubstituters = https://cache.nixos.org/"
      - name: Cache Results
        uses: mtoohey31/cache-flake-attrs@v2
        with:
          key: "${{ runner.os }}-nix-${{ hashFiles('./flake.lock', './flake.nix') }}"
      - name: Install Dependencies
        run: "nix profile install -L nixpkgs#pbzip2"
      - name: Build Hydra
        run: "nix build -L .#cross-hydra && pbzip2 ./result/bin/hydra -c > hydra.bz2"
      - name: Publish Artifact
        uses: actions/upload-artifact@v3
        with:
          path: hydra.bz2
      - name: Build Image
        run: "nix build -L .#docker-image && cp result hydra-docker.tar.gz"
      - name: Login to Registry
        run: "echo \"${{ secrets.GITHUB_TOKEN }}\" | docker login ghcr.io -u $ --password-stdin"
      - name: Publish Image
        run: "IMAGE_ID=\"$(echo \"ghcr.io/${{ github.repository_owner }}/${{ github.repository }}\" | tr '[A-Z]' '[a-z]')\"\nVERSION=\"$(echo \"${{ github.ref_name }}\" | sed -e 's/^v//')\"\ndocker tag '${{ github.repository }}' \"$IMAGE_ID:$VERSION\"\ndocker push \"$IMAGE_ID:$VERSION\""
name: Build
"on":
  pull_request: {}
  push:
    tags:
      - v*
